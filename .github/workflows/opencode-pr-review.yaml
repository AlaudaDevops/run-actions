name: OpenCode PR Review

on:
  workflow_call:
    inputs:
      repository:
        description: "Repository to review (owner/repo format)"
        required: true
        type: string
      pr_number:
        description: "Pull request number to review"
        required: true
        type: string
      review_style:
        description: "Review style (strict, balanced, lenient)"
        required: false
        default: "strict"
        type: string
      event_payload:
        description: "Pull request event payload"
        required: true
        type: string
      model:
        description: "Override model (provider/model). Defaults to OPENCODE_MODEL."
        required: false
        type: string
      prompt:
        description: "Override review prompt. Defaults to OPENCODE_REVIEW_PROMPT."
        required: false
        type: string
      dry_run:
        description: "Dry run mode (output review but don't post comments)"
        required: false
        default: false
        type: boolean
    secrets:
      OPENCODE_GITHUB_TOKEN:
        description: "Optional token for API calls; defaults to GITHUB_TOKEN"
        required: false
      TOKEN:
        description: "GitHub token with repo access"
        required: true
  workflow_dispatch:
    inputs:
      repository:
        description: "Repository to review (owner/repo format)"
        required: true
        type: string
      model:
        description: "Override model (provider/model). Defaults to OPENCODE_MODEL."
        required: false
        type: string
      prompt:
        description: "Override review prompt. Defaults to OPENCODE_REVIEW_PROMPT."
        required: false
        type: string
      pr_number:
        description: "Pull request number to review"
        required: true
        type: string
      event_payload:
        description: "Pull request event payload"
        required: true
        type: string
      review_style:
        description: "Review style (strict, balanced, lenient)"
        required: false
        default: "strict"
        type: string

env:
  # Fast tweak: update this model string to switch providers/models.
  OPENCODE_MODEL: "opencode/minimax-m2.5-free"
  # Simple default review prompt.
  OPENCODE_REVIEW_PROMPT: "Review this pull request for correctness, security, and maintainability. Provide a concise summary and add inline comments for actionable issues. You can use the gh cli to post/update your comments in the PR"

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          fetch-depth: 1
          token: ${{ secrets.TOKEN }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Install GitHub CLI
        uses: dev-hanz-ops/install-gh-cli-action@v0.2.1
        # with:
        # current latest
        # https://github.com/cli/cli/releases/tag/v2.81.0
        # gh-cli-version: 2.81.0

      - name: Auth with GitHub CLI
        run: |
          echo -n "${{ secrets.TOKEN }}" | gh auth login --with-token
          echo "âœ… GitHub CLI authenticated"

      - name: Install OpenCode CLI
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          curl -fsSL https://opencode.ai/install | OPENCODE_INSTALL_DIR="$HOME/.local/bin" bash
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          opencode --version

      - name: Clone target repository
        if: steps.validate-pr.outputs.skip != 'true'
        run: |
          REPO="${{ inputs.repository }}"
          PR_NUMBER="${{ inputs.pr_number }}"

          echo "ðŸ“¦ Cloning $REPO..."
          gh repo clone "$REPO" . -- --depth=1
          gh pr checkout $PR_NUMBER
          echo "âœ… Repository cloned and PR checked out"

      - name: Prepare OpenCode event payload
        env:
          INPUT_PROMPT: ${{ inputs.prompt }}
          INPUT_EVENT: ${{ inputs.event_payload }}
        run: |
          set -euo pipefail
          PROMPT="${INPUT_PROMPT:-$OPENCODE_REVIEW_PROMPT}"

          echo "$INPUT_EVENT" > opencode_event.json

          # # Inject prompt into the event payload for compatibility with pull_request events.
          # jq -c --arg prompt "$PROMPT" '
          #   .prompt = $prompt
          #   | .inputs = (.inputs // {})
          #   | .inputs.prompt = $prompt
          # ' "$GITHUB_EVENT_PATH" > opencode_event.json

      - name: Run OpenCode GitHub Agent
        env:
          INPUT_MODEL: ${{ inputs.model }}
          OPENCODE_GITHUB_TOKEN: ${{ secrets.TOKEN }}
          INPUT_PROMPT: ${{ inputs.prompt }}
        run: |
          set -euo pipefail
          MODEL="${INPUT_MODEL:-$OPENCODE_MODEL}"
          export MODEL
          export PROMPT="${INPUT_PROMPT:-$OPENCODE_REVIEW_PROMPT}"

          TOKEN="${OPENCODE_GITHUB_TOKEN:-$GITHUB_TOKEN}"
          opencode github run --token "$TOKEN" --event "$(cat opencode_event.json)"
